<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WeakHashMap那些事 | NeroBlackstone&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.efb332ed.css" as="style"><link rel="preload" href="/assets/js/app.ec2d5af2.js" as="script"><link rel="preload" href="/assets/js/3.e9bff2d3.js" as="script"><link rel="preload" href="/assets/js/31.39c4255a.js" as="script"><link rel="prefetch" href="/assets/js/10.7e730691.js"><link rel="prefetch" href="/assets/js/11.0a8c3a3b.js"><link rel="prefetch" href="/assets/js/12.e41009b6.js"><link rel="prefetch" href="/assets/js/13.615800ed.js"><link rel="prefetch" href="/assets/js/14.9ff2a10b.js"><link rel="prefetch" href="/assets/js/15.c0f3d8e0.js"><link rel="prefetch" href="/assets/js/16.267a81c0.js"><link rel="prefetch" href="/assets/js/17.85b26636.js"><link rel="prefetch" href="/assets/js/18.1172ae07.js"><link rel="prefetch" href="/assets/js/19.02da22ed.js"><link rel="prefetch" href="/assets/js/20.899cfc38.js"><link rel="prefetch" href="/assets/js/21.48a7b777.js"><link rel="prefetch" href="/assets/js/22.ae905edc.js"><link rel="prefetch" href="/assets/js/23.145304b2.js"><link rel="prefetch" href="/assets/js/24.fc9aa772.js"><link rel="prefetch" href="/assets/js/25.5370690c.js"><link rel="prefetch" href="/assets/js/26.4092c0ff.js"><link rel="prefetch" href="/assets/js/27.211a8f61.js"><link rel="prefetch" href="/assets/js/28.7b4de4b7.js"><link rel="prefetch" href="/assets/js/29.443848ae.js"><link rel="prefetch" href="/assets/js/30.8fb8f839.js"><link rel="prefetch" href="/assets/js/32.6e0fb50b.js"><link rel="prefetch" href="/assets/js/33.919f59b2.js"><link rel="prefetch" href="/assets/js/34.2fd50063.js"><link rel="prefetch" href="/assets/js/35.3dfac06e.js"><link rel="prefetch" href="/assets/js/36.a873c79a.js"><link rel="prefetch" href="/assets/js/37.85faec35.js"><link rel="prefetch" href="/assets/js/38.e83fe327.js"><link rel="prefetch" href="/assets/js/39.6be1856f.js"><link rel="prefetch" href="/assets/js/4.78206645.js"><link rel="prefetch" href="/assets/js/40.93ddf935.js"><link rel="prefetch" href="/assets/js/41.88d92bf1.js"><link rel="prefetch" href="/assets/js/42.b3d6f88b.js"><link rel="prefetch" href="/assets/js/43.1c5dc4d4.js"><link rel="prefetch" href="/assets/js/44.195f887c.js"><link rel="prefetch" href="/assets/js/45.9aec365f.js"><link rel="prefetch" href="/assets/js/46.a1714c92.js"><link rel="prefetch" href="/assets/js/47.07f6e748.js"><link rel="prefetch" href="/assets/js/48.edfe58e7.js"><link rel="prefetch" href="/assets/js/5.290e8a5b.js"><link rel="prefetch" href="/assets/js/6.0be4f557.js"><link rel="prefetch" href="/assets/js/7.df8bc73d.js"><link rel="prefetch" href="/assets/js/8.9882d415.js"><link rel="prefetch" href="/assets/js/9.62493693.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.07834b74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efb332ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><nav role="navigation" aria-label="main navigation" class="navbar is-primary is-fixed-top"><div class="navbar-brand"><a href="/" to="/" class="navbar-item router-link-active">
        NeroBlackstone's Blog
    </a><a role="button" aria-label="menu" class="navbar-burger burger"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/tag/" to="/tag/" class="navbar-item">Tag</a> <a href="/friends/" to="/friends/" class="navbar-item">Friends</a></div></div></nav> <section class="section"><div class="container"><div class="content__default"><h1 id="weakhashmap那些事"><a href="#weakhashmap那些事" class="header-anchor">#</a> WeakHashMap那些事</h1> <p>前面有文章谈了java中的四类引用。WeakHashMap就是其中弱引用的使用实例。</p> <p>WeakHashMap是基于哈希散列的Map接口的实现，但是它的键是弱引用的。</p> <p>当这个WeakHashMap的键不再被使用时，对应整个条目会被自动删除。所以这个映射的行为与其他映射有所不同。</p> <p>为了了解原理，在这篇文章中将自行设计一个简单的缓存实现。但是这仅仅是为了了解这个映射的原理，请不要在代码实践中照搬。</p> <h2 id="使用weakhashmap做缓存"><a href="#使用weakhashmap做缓存" class="header-anchor">#</a> 使用WeakHashMap做缓存</h2> <p>假设我们想构建一个缓存来存储极大的图片对象，图片名做键名。这时候应该选择一个适当的映射实现。</p> <p>直接用HashMap显然不是个好主意，因为对象占空间太大了，即使有的对象不使用，它们也不会被回收GC进程从缓存中回收。</p> <p>因此我们需要一个允许GC自动删除无用对象的Map实现。当图片的键没有被程序使用，整个条目都会从内存中删掉。</p> <p>WeakHashMap就是我们想要的！下面测试WeakHashMap并且观察它的行为：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> map <span class="token operator">=</span> WeakHashMap<span class="token operator">&lt;</span>UniqueImageName<span class="token operator">?</span><span class="token punctuation">,</span> BigImage<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> bigImage <span class="token operator">=</span> <span class="token function">BigImage</span><span class="token punctuation">(</span><span class="token string">&quot;image_id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> imageName<span class="token operator">:</span> UniqueImageName<span class="token operator">?</span> <span class="token operator">=</span> <span class="token function">UniqueImageName</span><span class="token punctuation">(</span><span class="token string">&quot;name_of_big_image&quot;</span><span class="token punctuation">)</span>

map<span class="token punctuation">[</span>imageName<span class="token punctuation">]</span> <span class="token operator">=</span> bigImage
<span class="token function">assertTrue</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>imageName<span class="token punctuation">)</span><span class="token punctuation">)</span>

imageName <span class="token operator">=</span> <span class="token keyword">null</span>
System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atMost</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span>map<span class="token operator">::</span>isEmpty<span class="token punctuation">)</span>
</code></pre></div><p>先创建一个拿来存BigImage对象的WeakHashMap，我们将BigImage作为映射的值，imageName对象引用作为键。imageName将使用弱引用存于映射中。</p> <p>下面将imageName引用设定为null，因此不再会有引用指向bigImage对象。默认情况下，WeakHashMap会在下一次GC执行时回收没有引用的条目。</p> <p>之后调用System.go强制触发GC。GC结束后，WeakHashMap便会为空。</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> map <span class="token operator">=</span> WeakHashMap<span class="token operator">&lt;</span>UniqueImageName<span class="token operator">?</span><span class="token punctuation">,</span> BigImage<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> bigImageFirst <span class="token operator">=</span> <span class="token function">BigImage</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> imageNameFirst<span class="token operator">:</span> UniqueImageName<span class="token operator">?</span> <span class="token operator">=</span> <span class="token function">UniqueImageName</span><span class="token punctuation">(</span><span class="token string">&quot;name_of_big_image&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> bigImageSecond <span class="token operator">=</span> <span class="token function">BigImage</span><span class="token punctuation">(</span><span class="token string">&quot;foo_2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> imageNameSecond <span class="token operator">=</span> <span class="token function">UniqueImageName</span><span class="token punctuation">(</span><span class="token string">&quot;name_of_big_image_2&quot;</span><span class="token punctuation">)</span>

map<span class="token punctuation">[</span>imageNameFirst<span class="token punctuation">]</span> <span class="token operator">=</span> bigImageFirst
map<span class="token punctuation">[</span>imageNameSecond<span class="token punctuation">]</span> <span class="token operator">=</span> bigImageSecond

<span class="token function">assertTrue</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>imageNameFirst<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">assertTrue</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>imageNameSecond<span class="token punctuation">)</span><span class="token punctuation">)</span>

imageNameFirst <span class="token operator">=</span> <span class="token keyword">null</span>
System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atMost</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span><span class="token punctuation">{</span> map<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atMost</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span><span class="token punctuation">{</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>imageNameSecond<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个例子中，只有imageNameFirst设为空，而imageNameSecond引用未改变。在GC后，整个映射就剩imageNameSecond一个条目了。</p></div> <!----></div></section> <footer class="footer" data-v-29777868><div class="level" data-v-29777868><div class="content level-item has-text-centered" data-v-29777868><div class="field is-grouped-multiline is-grouped" data-v-29777868><!----> <div class="control" data-v-29777868><span class="tag is-primary" data-v-29777868><span><a href="https://github.com/NeroBlackstone" class="has-text-white" data-v-29777868><span class="icon" data-v-29777868><i class="fab fa-github" data-v-29777868></i></span></a></span> <!----></span></div> <div class="control" data-v-29777868><a href="https://v1.vuepress.vuejs.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>vuepress</span> <!----></span> <span class="tag is-info" data-v-29777868><span>1.5.0</span> <!----></span></div></a></div><div class="control" data-v-29777868><a href="https://buefy.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>buefy</span> <!----></span> <span class="tag is-info" data-v-29777868><span>0.8.20</span> <!----></span></div></a></div> <!----></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ec2d5af2.js" defer></script><script src="/assets/js/3.e9bff2d3.js" defer></script><script src="/assets/js/31.39c4255a.js" defer></script>
  </body>
</html>
