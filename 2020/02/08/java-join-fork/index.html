<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>java Join/Fork 简介 | NeroBlackstone&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.efb332ed.css" as="style"><link rel="preload" href="/assets/js/app.ec2d5af2.js" as="script"><link rel="preload" href="/assets/js/3.e9bff2d3.js" as="script"><link rel="preload" href="/assets/js/33.919f59b2.js" as="script"><link rel="prefetch" href="/assets/js/10.7e730691.js"><link rel="prefetch" href="/assets/js/11.0a8c3a3b.js"><link rel="prefetch" href="/assets/js/12.e41009b6.js"><link rel="prefetch" href="/assets/js/13.615800ed.js"><link rel="prefetch" href="/assets/js/14.9ff2a10b.js"><link rel="prefetch" href="/assets/js/15.c0f3d8e0.js"><link rel="prefetch" href="/assets/js/16.267a81c0.js"><link rel="prefetch" href="/assets/js/17.85b26636.js"><link rel="prefetch" href="/assets/js/18.1172ae07.js"><link rel="prefetch" href="/assets/js/19.02da22ed.js"><link rel="prefetch" href="/assets/js/20.899cfc38.js"><link rel="prefetch" href="/assets/js/21.48a7b777.js"><link rel="prefetch" href="/assets/js/22.ae905edc.js"><link rel="prefetch" href="/assets/js/23.145304b2.js"><link rel="prefetch" href="/assets/js/24.fc9aa772.js"><link rel="prefetch" href="/assets/js/25.5370690c.js"><link rel="prefetch" href="/assets/js/26.4092c0ff.js"><link rel="prefetch" href="/assets/js/27.211a8f61.js"><link rel="prefetch" href="/assets/js/28.7b4de4b7.js"><link rel="prefetch" href="/assets/js/29.443848ae.js"><link rel="prefetch" href="/assets/js/30.8fb8f839.js"><link rel="prefetch" href="/assets/js/31.39c4255a.js"><link rel="prefetch" href="/assets/js/32.6e0fb50b.js"><link rel="prefetch" href="/assets/js/34.2fd50063.js"><link rel="prefetch" href="/assets/js/35.3dfac06e.js"><link rel="prefetch" href="/assets/js/36.a873c79a.js"><link rel="prefetch" href="/assets/js/37.85faec35.js"><link rel="prefetch" href="/assets/js/38.e83fe327.js"><link rel="prefetch" href="/assets/js/39.6be1856f.js"><link rel="prefetch" href="/assets/js/4.78206645.js"><link rel="prefetch" href="/assets/js/40.93ddf935.js"><link rel="prefetch" href="/assets/js/41.88d92bf1.js"><link rel="prefetch" href="/assets/js/42.b3d6f88b.js"><link rel="prefetch" href="/assets/js/43.1c5dc4d4.js"><link rel="prefetch" href="/assets/js/44.195f887c.js"><link rel="prefetch" href="/assets/js/45.9aec365f.js"><link rel="prefetch" href="/assets/js/46.a1714c92.js"><link rel="prefetch" href="/assets/js/47.07f6e748.js"><link rel="prefetch" href="/assets/js/48.edfe58e7.js"><link rel="prefetch" href="/assets/js/5.290e8a5b.js"><link rel="prefetch" href="/assets/js/6.0be4f557.js"><link rel="prefetch" href="/assets/js/7.df8bc73d.js"><link rel="prefetch" href="/assets/js/8.9882d415.js"><link rel="prefetch" href="/assets/js/9.62493693.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.07834b74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efb332ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><nav role="navigation" aria-label="main navigation" class="navbar is-primary is-fixed-top"><div class="navbar-brand"><a href="/" to="/" class="navbar-item router-link-active">
        NeroBlackstone's Blog
    </a><a role="button" aria-label="menu" class="navbar-burger burger"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/tag/" to="/tag/" class="navbar-item">Tag</a> <a href="/friends/" to="/friends/" class="navbar-item">Friends</a></div></div></nav> <section class="section"><div class="container"><div class="content__default"><h1 id="java-join-fork-简介"><a href="#java-join-fork-简介" class="header-anchor">#</a> java Join/Fork 简介</h1> <p>Join/Fork是java 7时代面世的。它通过尝试使用所有处理器核心，帮助加速并行计算 - <strong>这是通过分而治之的方法实现的</strong> 。</p> <p>首先Fork会执行，意味着将任务递归地分解成更小的独立子任务，直到这些子任务简单到可以异步执行。</p> <p>之后Join部分开始，所有子任务递归地合并到单个结果中，或者任务返回空，程序仅执行掉所有子任务。</p> <p>为了提供有效的并行计算，join/fork使用了名为ForkJoinPool的线程池，该线程池管理ForkJoinWorkerThread类型的工作线程。</p> <h2 id="forkjoinpool"><a href="#forkjoinpool" class="header-anchor">#</a> ForkJoinPool</h2> <p>ForkJoinPool是Join/Fork框架的核心。它是ExecutorService的实现，用于管理工作线程，并且使我们可以获取线程池状态和性能的信息。</p> <p>工作线程每次只能执行一个任务，但是ForkJoinPool不会为每个子任务都创建独立的线程。相反，每个池中的线程都有自己的双端队列来存储任务</p> <p>借助<strong>工作窃取（work-stealing algorithm）算法</strong>，这种架构设计对于平衡线程负载至关重要。</p> <h3 id="工作窃取算法"><a href="#工作窃取算法" class="header-anchor">#</a> 工作窃取算法</h3> <p><strong>简单描述工作窃取：空闲线程会尝试从繁忙的线程中&quot;窃取&quot;工作。</strong></p> <p>默认情况下，工作线程从自己的双端队列的头取得任务。当自己的队列为空时，线程会从另一个繁忙的线程的双端队列的尾，或是全局条目队列中获取任务，因为这里的工作量一般比较大。</p> <p>这种算法最小化了线程竞争任务的可能性。由于它首先处理运算量最大的工作，因此也减少了线程寻找工作的次数。</p> <h3 id="实例化forkjoinpool"><a href="#实例化forkjoinpool" class="header-anchor">#</a> 实例化ForkJoinPool</h3> <p>在java8中，最方便的访问ForkJoinPool实例的方法是使用它的静态方法commonPool()。顾名思义，这将提供对公共池（commonPool）引用，该池是每个ForkJoinPool的默认线程池。</p> <p>使用预定义的公共池可以降低资源消耗，因为这会阻止为每个任务创建单独的线程池。</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> commonPool <span class="token operator">=</span> ForkJoinPool<span class="token punctuation">.</span><span class="token function">commonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="forkjointask"><a href="#forkjointask" class="header-anchor">#</a> ForkJoinTask</h2> <p>ForkJoinTask是ForkJoinPool中执行的基础任务类型。在实践中，应该扩展其两个子类之一：对于没有返回值的类型，使用RecursiveAction，对于带有返回值的任务，使用RecursiveTask。它们都有一个抽象方法compute()，其中定义任务的逻辑。</p> <h3 id="recursiveaction"><a href="#recursiveaction" class="header-anchor">#</a> RecursiveAction</h3> <p>在下面的示例中，要处理的工作单元用被称为workload的字符串表示。出于演示目的，该任务没有实际意义：把输入转换为大写并且打印。</p> <p>为了演示分叉的行为，<strong>这个例子中，如果workload.length()大于指定阈值，将会使用createSubtask()方法拆分任务。</strong></p> <p>字符串会递归地分割为子串，创建基于这些字串的 CustomRecursiveTask实例。该方法返回一个列表，这个列表使用invokeAll()方法提交到ForkJoinPool。</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">CustomRecursiveAction</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> workload<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">RecursiveAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> THRESHOLD <span class="token operator">=</span> <span class="token number">4</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> logger <span class="token operator">=</span> Logger<span class="token punctuation">.</span><span class="token function">getAnonymousLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workload<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> THRESHOLD<span class="token punctuation">)</span>
            ForkJoinTask<span class="token punctuation">.</span><span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
            <span class="token function">processing</span><span class="token punctuation">(</span>workload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>CustomRecursiveAction<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
            <span class="token function">CustomRecursiveAction</span><span class="token punctuation">(</span>workload<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> workload<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">CustomRecursiveAction</span><span class="token punctuation">(</span>workload<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>workload<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> workload<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">processing</span><span class="token punctuation">(</span>work<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> work<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;This result - (<span class="token interpolation variable">$result</span>) - was processed by <span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此模式可以用于开发自己的RecursiveAction类。为此，创建一个代表总工作的对象，选择合适的阈值，定义切分工作的方法，定义执行工作的方法。</p> <h3 id="recursivetask"><a href="#recursivetask" class="header-anchor">#</a> RecursiveTask</h3> <p>对于有返回值的任务，此处的逻辑是类似的，只是每个子任务都合并为一个结果。</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">CustomRecursiveTask</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> arr<span class="token operator">:</span> IntArray<span class="token punctuation">)</span> <span class="token operator">:</span> RecursiveTask<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> THRESHOLD <span class="token operator">=</span> <span class="token number">20</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> THRESHOLD<span class="token punctuation">)</span>
        ForkJoinTask<span class="token punctuation">.</span><span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
            <span class="token function">processing</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">createSubtasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Collection<span class="token operator">&lt;</span>CustomRecursiveTask<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
            <span class="token function">CustomRecursiveTask</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">CustomRecursiveTask</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">processing</span><span class="token punctuation">(</span>arr<span class="token operator">:</span> IntArray<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> it <span class="token keyword">in</span> <span class="token number">11</span><span class="token operator">..</span><span class="token number">26</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it <span class="token operator">*</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在此示例中，工作由一个存储于CustomRecursiveTask类的arr字段的数组代表。 createSubtask()方法将任务递归地分为更小的工作，直到每个工作都小于阈值。然后invokeAll（）函数提交子任务给通用请求，返回Future列表。</p> <p>为了触发执行，为每个子任务调用join()方法。</p> <h2 id="提交任务到forkjoinpool中"><a href="#提交任务到forkjoinpool中" class="header-anchor">#</a> 提交任务到ForkJoinPool中</h2> <p>要提交任务到线程池中，可以使用下面几种方法：</p> <p>submit()或execute()方法（它们的用例是相同的）：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code>forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>customRecursiveTask<span class="token punctuation">)</span>
<span class="token keyword">val</span> result<span class="token operator">:</span> Int <span class="token operator">=</span> customRecursiveTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>invoke()方法将任务fork并等待结果，且不需要手动join：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> result<span class="token operator">:</span> Int <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>customRecursiveTask<span class="token punctuation">)</span>
</code></pre></div><p>invokeAll()方法是将一系列ForkJoinTask提交给ForkJoinPool最简单的方法。它以任务为参数（可以是多个任务，可变参数，或是一个任务集合），将任务fork并以Future对象产生的顺序，返回Future对象的集合。</p> <p>另外，也可以单独使用fork()和join()方法。fork()方法提交任务到池中，但是它不会触发执行。join()方法用于执行。在RecursiveAction情况下，join()只返回空，而对于RecursiveTask，他会返回任务执行的结果：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code>customRecursiveTaskFirst<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> customRecursiveTaskLast<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>在RecursiveTask的例子中，我们使用了invokeAll()方法，来提交一系列的子任务到线程池中。可以用fork()和join()达到相同的效果，但是会影响结果的顺序。</p> <p>为避免混淆，最好使用invokeAll()方法来提交多个任务到线程池中。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>使用fork/join框架可以加速处理更大的任务，但是要实现此结果，应该遵循一些准则：</p> <ul><li><strong>使用尽可能少的线程池</strong> - 大多数情况下，最佳的选择是每个应用或系统只用一个线程池。</li> <li><strong>使用默认的公共线程池</strong> ，如果没有特定调整的需要的话。</li> <li><strong>使用合理的阈值</strong> 来切分ForkJoinTask为子任务。</li> <li><strong>避免任何ForkJoinTasks的阻塞</strong></li></ul></div> <!----></div></section> <footer class="footer" data-v-29777868><div class="level" data-v-29777868><div class="content level-item has-text-centered" data-v-29777868><div class="field is-grouped-multiline is-grouped" data-v-29777868><!----> <div class="control" data-v-29777868><span class="tag is-primary" data-v-29777868><span><a href="https://github.com/NeroBlackstone" class="has-text-white" data-v-29777868><span class="icon" data-v-29777868><i class="fab fa-github" data-v-29777868></i></span></a></span> <!----></span></div> <div class="control" data-v-29777868><a href="https://v1.vuepress.vuejs.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>vuepress</span> <!----></span> <span class="tag is-info" data-v-29777868><span>1.5.0</span> <!----></span></div></a></div><div class="control" data-v-29777868><a href="https://buefy.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>buefy</span> <!----></span> <span class="tag is-info" data-v-29777868><span>0.8.20</span> <!----></span></div></a></div> <!----></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ec2d5af2.js" defer></script><script src="/assets/js/3.e9bff2d3.js" defer></script><script src="/assets/js/33.919f59b2.js" defer></script>
  </body>
</html>
