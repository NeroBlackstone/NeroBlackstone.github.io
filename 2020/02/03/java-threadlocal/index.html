<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>java ThreadLocal 简介 | NeroBlackstone&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.efb332ed.css" as="style"><link rel="preload" href="/assets/js/app.ec2d5af2.js" as="script"><link rel="preload" href="/assets/js/3.e9bff2d3.js" as="script"><link rel="preload" href="/assets/js/42.b3d6f88b.js" as="script"><link rel="prefetch" href="/assets/js/10.7e730691.js"><link rel="prefetch" href="/assets/js/11.0a8c3a3b.js"><link rel="prefetch" href="/assets/js/12.e41009b6.js"><link rel="prefetch" href="/assets/js/13.615800ed.js"><link rel="prefetch" href="/assets/js/14.9ff2a10b.js"><link rel="prefetch" href="/assets/js/15.c0f3d8e0.js"><link rel="prefetch" href="/assets/js/16.267a81c0.js"><link rel="prefetch" href="/assets/js/17.85b26636.js"><link rel="prefetch" href="/assets/js/18.1172ae07.js"><link rel="prefetch" href="/assets/js/19.02da22ed.js"><link rel="prefetch" href="/assets/js/20.899cfc38.js"><link rel="prefetch" href="/assets/js/21.48a7b777.js"><link rel="prefetch" href="/assets/js/22.ae905edc.js"><link rel="prefetch" href="/assets/js/23.145304b2.js"><link rel="prefetch" href="/assets/js/24.fc9aa772.js"><link rel="prefetch" href="/assets/js/25.5370690c.js"><link rel="prefetch" href="/assets/js/26.4092c0ff.js"><link rel="prefetch" href="/assets/js/27.211a8f61.js"><link rel="prefetch" href="/assets/js/28.7b4de4b7.js"><link rel="prefetch" href="/assets/js/29.443848ae.js"><link rel="prefetch" href="/assets/js/30.8fb8f839.js"><link rel="prefetch" href="/assets/js/31.39c4255a.js"><link rel="prefetch" href="/assets/js/32.6e0fb50b.js"><link rel="prefetch" href="/assets/js/33.919f59b2.js"><link rel="prefetch" href="/assets/js/34.2fd50063.js"><link rel="prefetch" href="/assets/js/35.3dfac06e.js"><link rel="prefetch" href="/assets/js/36.a873c79a.js"><link rel="prefetch" href="/assets/js/37.85faec35.js"><link rel="prefetch" href="/assets/js/38.e83fe327.js"><link rel="prefetch" href="/assets/js/39.6be1856f.js"><link rel="prefetch" href="/assets/js/4.78206645.js"><link rel="prefetch" href="/assets/js/40.93ddf935.js"><link rel="prefetch" href="/assets/js/41.88d92bf1.js"><link rel="prefetch" href="/assets/js/43.1c5dc4d4.js"><link rel="prefetch" href="/assets/js/44.195f887c.js"><link rel="prefetch" href="/assets/js/45.9aec365f.js"><link rel="prefetch" href="/assets/js/46.a1714c92.js"><link rel="prefetch" href="/assets/js/47.07f6e748.js"><link rel="prefetch" href="/assets/js/48.edfe58e7.js"><link rel="prefetch" href="/assets/js/5.290e8a5b.js"><link rel="prefetch" href="/assets/js/6.0be4f557.js"><link rel="prefetch" href="/assets/js/7.df8bc73d.js"><link rel="prefetch" href="/assets/js/8.9882d415.js"><link rel="prefetch" href="/assets/js/9.62493693.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.07834b74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efb332ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><nav role="navigation" aria-label="main navigation" class="navbar is-primary is-fixed-top"><div class="navbar-brand"><a href="/" to="/" class="navbar-item router-link-active">
        NeroBlackstone's Blog
    </a><a role="button" aria-label="menu" class="navbar-burger burger"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/tag/" to="/tag/" class="navbar-item">Tag</a> <a href="/friends/" to="/friends/" class="navbar-item">Friends</a></div></div></nav> <section class="section"><div class="container"><div class="content__default"><h1 id="java-threadlocal-简介"><a href="#java-threadlocal-简介" class="header-anchor">#</a> java ThreadLocal 简介</h1> <p>ThreadLocal允许我们存储<strong>只能被特定线程访问</strong> 的数据。</p> <p>假设我们现在需要一个与特定线程绑定的Integer值：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> threadLocalValue <span class="token operator">=</span> ThreadLocal<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>接想从线程中使用该值，只需要调用get()/set()方法。可以理解为ThreadLocal将数据存储在以线程为键的映射中。</p> <p>可以在threadLocalValue上调用get方法来为当前线程取得整数值：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code>threadLocalValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> result <span class="token operator">=</span> threadLocalValue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>也可以通过向withInitial静态函数传值来初始化ThreadLocal实例：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> threadLocal <span class="token operator">=</span> ThreadLocal<span class="token punctuation">.</span><span class="token function">withInitial</span> <span class="token punctuation">{</span> <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre></div><p>要从ThreadLocal中删除值，我们可以调用remove()方法：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code>threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>要了解如何正确使用ThreadLocal，先看一个没用ThreadLocal的例子，然后用ThreadLocal重写这个例子。</p> <h2 id="在映射中存储用户数据"><a href="#在映射中存储用户数据" class="header-anchor">#</a> 在映射中存储用户数据</h2> <p>假设有一个需要根据给定的用户id存储特定用户上下文数据的程序：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">Context</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> userName<span class="token operator">:</span> String<span class="token punctuation">)</span>
</code></pre></div><p>我们希望每个用户id都交由一个线程去处理。先创建一个SharedMapWithUserContext类实现了Runnable接口。run()方法中，通过UserRepository类调用数据库，用给定的userId返回了一个Context对象。</p> <p>然后根据userId为键将上下文传入ConcurentHashMap：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">SharedMapWithUserContext</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> userId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> userRepository<span class="token operator">=</span> <span class="token function">UserRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> userName<span class="token operator">:</span> String <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">getUserNameForUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
        userContextPerUserId<span class="token punctuation">[</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Context</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> userContextPerUserId<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>Int<span class="token operator">?</span><span class="token punctuation">,</span> Context<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>两个不同的userId分别创建两个线程，并且断言可以看出已经有两个条目在userContextPerUserId映射中:</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token function">thread</span><span class="token punctuation">(</span>start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SharedMapWithUserContext</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token function">thread</span><span class="token punctuation">(</span>start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SharedMapWithUserContext</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span>SharedMapWithUserContext<span class="token punctuation">.</span>userContextPerUserId<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="在threadlocal存储用户数据"><a href="#在threadlocal存储用户数据" class="header-anchor">#</a> 在ThreadLocal存储用户数据</h2> <p>我们可以重写上面的例子，以ThreadLocal存储用户上下文。每个线程将有自己的ThreadLocal实例。</p> <p>使用ThreadLocal需要非常小心，因为每个ThreadLocal实例都与特定的线程相关。在下面的示例中，每个特定的userId都有专用线程，并且这些线程由我们自己创建，可以完全控制它们。</p> <p>run()方法将获取用户上下文并用set()方法将其存储在ThreadLocal变量内：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">ThreadLocalWithUserContext</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> userId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> userRepository<span class="token operator">=</span> <span class="token function">UserRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> userName<span class="token operator">:</span> String <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">getUserNameForUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
        userContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">Context</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;thread context for given userId: <span class="token interpolation variable">$userId</span> is: <span class="token interpolation"><span class="token delimiter variable">${</span>userContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> userContext<span class="token operator">:</span> ThreadLocal<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> <span class="token operator">=</span> ThreadLocal<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以通过启动两个线程对其进行测试，这两个线程都会对给定的userId执行操作：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token function">thread</span><span class="token punctuation">(</span>start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ThreadLocalWithUserContext</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token function">thread</span><span class="token punctuation">(</span>start <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ThreadLocalWithUserContext</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre></div><p>运行此段代码后，我们将在标准输出中看到为每个线程设置的ThreadLocal：</p> <div class="language- extra-class"><pre class="language-text"><code>thread context for given userId: 1 is: Context{userNameSecret='18a78f8e-24d2-4abf-91d6-79eaa198123f'}
thread context for given userId: 2 is: Context{userNameSecret='e19f6a0a-253e-423e-8b2b-bca1f471ae5c'}
</code></pre></div><p>我们可以看到每个用户都有自己的上下文。</p> <h2 id="不要将threadlocal和executorservice一起用"><a href="#不要将threadlocal和executorservice一起用" class="header-anchor">#</a> 不要将ThreadLocal和ExecutorService一起用</h2> <p>如果我们要使用ExecutorService并向其提交Runnable，则使用ThreadLocal会产生不确定的结果-因为我们无法保证给定userId的每个Runnable动作每次执行时都会由同一个线程处理。</p> <p>因此，我们的ThreadLocal将在不同的userId之间共享。这就是为什么我们不应该将TheadLocal与ExecutorService一起使用。仅当我们完全控制哪个线程将选择要执行的可运行操作时，才应使用它。</p></div> <!----></div></section> <footer class="footer" data-v-29777868><div class="level" data-v-29777868><div class="content level-item has-text-centered" data-v-29777868><div class="field is-grouped-multiline is-grouped" data-v-29777868><!----> <div class="control" data-v-29777868><span class="tag is-primary" data-v-29777868><span><a href="https://github.com/NeroBlackstone" class="has-text-white" data-v-29777868><span class="icon" data-v-29777868><i class="fab fa-github" data-v-29777868></i></span></a></span> <!----></span></div> <div class="control" data-v-29777868><a href="https://v1.vuepress.vuejs.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>vuepress</span> <!----></span> <span class="tag is-info" data-v-29777868><span>1.5.0</span> <!----></span></div></a></div><div class="control" data-v-29777868><a href="https://buefy.org/" data-v-29777868><div class="tags has-addons" data-v-29777868><span class="tag is-dark" data-v-29777868><span>buefy</span> <!----></span> <span class="tag is-info" data-v-29777868><span>0.8.20</span> <!----></span></div></a></div> <!----></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ec2d5af2.js" defer></script><script src="/assets/js/3.e9bff2d3.js" defer></script><script src="/assets/js/42.b3d6f88b.js" defer></script>
  </body>
</html>
